---
title: "Causal Pivot Power Analysis"
author: "CJ Williams"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"

output:
  html_document:
    number_sections: yes
    toc: yes
    
knitr:
  opts_chunk:
    cache: true
    cache.path: ".data/cache"
---

# Causal Pivot Power Analysis

We investigate the power properties of the causal pivot likelihood ratio test (lrt)
under the logistic (logitG) and liability (liabilityG) models.
We relate the power of these tests to other comparators including forward
logistic regression, cases-only reverse logistic regression, z-tests and Man-Whitney-Wilcox tests.
We further investigate the robustness of our tests to overestimation and underestimation of
allele frequency (omega) values for data sets with and without an effect from G to Y (respectively)


```{r load_libraries, echo = F, message = F, warning = F}
library(parallel, quietly = T, warn.conflicts = F)
library(lmtest, quietly = T, warn.conflicts = F)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(patchwork)

source('utils.R')
```

```{r create_out_dir, echo=F}
out.dir <- '.data/power_analysis/'
dir.create(out.dir, recursive = T, showWarnings = F)
```

# Main LRT + Comparator Power Analysis ####

## run sims

```{r excute_main_lrt_sims, cache=T}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())

f.lrt <- function(params) {
  sim.result <- f.call(sim, params)
  x <- as.data.frame(sim.result)
  
  lrt.cc <- run.mle(sim.result, params, cases.only = F)
  lrt.co <- run.mle(sim.result, params, cases.only = T)
  
  fwd.p.val <- lmtest::lrtest(
    glm(Y ~ 1 + X + G + GX, family = binomial(link = 'logit'), data = x),
    glm(Y ~ 1 + X, family = binomial(link = 'logit'), data = x)
  )[2,5]
  
  wilcox.p.val <- wilcox.test(
    X ~ G,
    data = x[x$Y==1,],
    alternative = 'greater'
  )$p.value
  
  setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
    modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
    modifyList(
      list(
        fwd.p.val = fwd.p.val,
        wilcox.p.val = wilcox.p.val
      )
    ) %>%
      modifyList(z.test(w = params$omega, sim.result))
}

params <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  beta = 0.6
)

gamma.range <- seq(0.0, 1.2, length.out = 8)
eta.range <- c(-0.4, 0)

n.sims <- 1024

lrt.ranges <- expand.grid(gamma = gamma.range, eta = eta.range)

lrt.result <- mapply(function(gamma, eta) {
  params$gamma <- gamma
  params$eta <- eta
  
  r <- run.lrt(f.lrt, params, n.sims = n.sims)
  
  r$param.gamma <- params$gamma
  r$param.omega <- params$omega
  r$param.alpha <- params$alpha
  r$param.beta <- params$beta
  r$param.eta <- params$eta
  
  r
}, lrt.ranges$gamma, lrt.ranges$eta, SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

saveRDS(lrt.result, file.path(out.dir, 'main.lrt.result.rds'))
```

## generate power curve

```{r generate_main_power_curve}
lrt.power <- lrt.result %>%
  select(param.gamma, param.eta, ends_with('gamma'), ends_with('.p.val')) %>%
  mutate(
    cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(across(starts_with('param')), test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup() %>%
  filter(test != 'cc.lrt') %>%
  mutate(test = gsub('^co.', '', test))

lrt.power.sigmoid <- expand.grid(unique(lrt.power$test), unique(lrt.power$param.eta)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    param.eta <- as.numeric(vals[2])
    power.df <- lrt.power[
      lrt.power$test == test & lrt.power$param.eta == param.eta,]
    my.sigmoid <- fit.sigmoid(power.df$param.gamma, power.df$power) %>%
      rename('param.gamma' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid$param.eta <- param.eta
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.power$src <- 'data'
lrt.power.sigmoid$src <- 'fit'

compare.df <- bind_rows(
  lrt.power,
  lrt.power.sigmoid
) %>%
  mutate(param.eta = as.factor(param.eta))

test.colors <- c(
  'lrt' = '#f42e3d',
  'fwd' = '#2ff481',
  'wilcox' = '#e32ff4',
  'z' = '#2ff4e4'
)

power.plt <- (
  compare.df %>%
  ggplot(aes(x = param.gamma, y = power, color = test)) +
  scale_color_manual(values = test.colors) +
  geom_line(aes(linetype = param.eta), linewidth = 2/3,
    data = subset(compare.df, src == 'fit')
  ) +
  geom_point(aes(shape = param.eta), size = 2,
    data = subset(compare.df, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '-0.4' = 21,
    '0' = 16
  )) +
  scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
  scale_x_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, by = 0.2)) +
  labs(
    x = expression(gamma),
    y = 'Power',
    color = 'Test',
    shape = expression(eta),
    linetype = expression(eta),
  )
) %>%
  save.plot('lrt.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.plt
```

# mis-specified omega power - non-null ####

## run sims

```{r run_misspec_omega_sims, cache=T}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())

params.o <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  beta = 0.6,
  gamma = 2.2,
  eta = 0
)

n.o.sims <- 128
omega.range <- seq(0.001, 0.006, by = 0.0005)

f.lrt.mis.omega <- function(params) {
  sim.result <- f.call(sim, params)
  
  n.Y1 <- sum(sim.result$Y)
  n.Y1G1 <- sum(sim.result$Y & sim.result$G)
  o <- n.Y1G1 / n.Y1
  
  lapply(omega.range, function(omega) {
    o.s <- omega
    if (o.s <= 0) {
      return(NULL)
    }
    params$omega <- o.s
    
    lrt.co <- run.mle(sim.result, params, cases.only = T)
    
    lrt.co %>%
      modifyList(
        list(
          n.Y1 = n.Y1,
          n.Y1G1 = n.Y1G1,
          o = o,
          o.s = o.s,
          z = (n.Y1G1 - (n.Y1 * o.s)) / sqrt(o.s * (1 - o.s) * n.Y1)
        )
      )
  }) %>%
    do.call(bind_rows, .)
}

wilcox.1t.p.vals <- mclapply(seq(1024), function(i) {
  sim.result <- f.call(sim, params.o)
  
  wilcox.test(
    X ~ G,
    data = filter(as.data.frame(sim.result), Y == 1),
    alternative = 'greater'
  )$p.value
}, mc.cores = n.cores) 

wilcox.1t.power <- mean(wilcox.1t.p.vals < 0.05)

lrt.o.result <- run.lrt(f.lrt.mis.omega, params = params.o, n.sims = n.o.sims) %>%
  as_tibble()

# saveRDS(lrt.o.result, file.path(out.dir, 'overestimation.lrt.result.rds'))
lrt.o.result <- readRDS(file.path(out.dir, 'overestimation.lrt.result.rds'))
```

## generate power curves

```{r generate}
lrt.o.power <- lrt.o.result %>%
  mutate(
    lrt.p.val = ifelse(gamma < 0, 1, lrt.p.val),
    z.p.val = 1 - pnorm(z)
  ) %>%
  select(o.s, lrt.p.val, z.p.val) %>%
  pivot_longer(cols = ends_with('p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(o.s, test) %>%
  summarize(power = mean(p.val < 0.05))

lrt.o.power.sigmoid <- expand.grid(unique(lrt.o.power$test)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    power.df <- lrt.o.power[lrt.o.power$test == test,]
    my.sigmoid <- fit.sigmoid(power.df$o.s, power.df$power, res.fit = 0.00005) %>%
      rename('o.s' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.o.power$src <- 'data'
lrt.o.power.sigmoid$src <- 'fit'

compare.o.df <- bind_rows(
  lrt.o.power,
  lrt.o.power.sigmoid
)

test.o.colors <- c(
  'lrt' = '#f42e3d',
  'z' = '#2ff4e4'
)

power.o.plt <- (
  compare.o.df %>%
  ggplot(aes(x = o.s, y = power, color = test)) +
  scale_color_manual(values = test.o.colors) +
  geom_line(linewidth = 2/3,
    data = subset(compare.o.df, src == 'fit')
  ) +
  geom_point(size = 2,
    data = subset(compare.o.df, src == 'data')
  ) +
  # scale_shape_manual(values = c(
  #   '-0.4' = 16,
  #   '0' = 21
  # )) +
  # scale_linetype_manual(values = c('0' = 'dotted', '-0.4' = 'solid')) +
  # geom_hline(yintercept = wilcox.1t.power, linetype = 'dashed') +
  geom_vline(xintercept = params.o$omega, linetype = 'dashed') +
  geom_vline(xintercept = median(lrt.o.result$o), linetype = 'dotted') +
  scale_x_continuous(
    limits = c(0.001, 0.006),
    breaks = seq(0.001, 0.006, by = 0.001)
  ) +
  labs(
    x = expression(omega^'*'),
    y = 'Power',
    color = 'Test',
  )
) %>%
  save.plot('lrt.o.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.o.plt
```

# disease enrichment type 1 error ####

## run sims

```{r run_disease_enrichment_sims, cache=T}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())

omega.e.range <- seq(0.0002, 0.0012, by = 0.0001)

f.lrt.enriched.omega <- function(params) {
  sim.result <- f.call(sim, params)
  
  n.Y1 <- sum(sim.result$Y)
  n.Y1G1 <- sum(sim.result$Y & sim.result$G)
  o <- n.Y1G1 / n.Y1
  
  s <- sqrt((params$omega * (1 - params$omega)) / n.Y1)
  
  lapply(omega.e.range, function(omega) {
    params$omega <- omega
    
    lrt.co <- run.mle(sim.result, params, cases.only = T)

    lrt.co %>%
      modifyList(
        list(
          n.Y1 = n.Y1,
          n.Y1G1 = n.Y1G1,
          o = o,
          s = s,
          omega = omega,
          z = (n.Y1G1 - (n.Y1 * omega)) / sqrt(omega * (1 - omega) * n.Y1)
        )
      )
  }) %>%
    do.call(bind_rows, .)
}

params.e <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  beta = 0.6,
  gamma = 0,
  eta = 0
)

n.e.sims <- 128

lrt.e.result <- run.lrt(f.lrt.enriched.omega, params = params.e, n.sims = n.e.sims) %>%
  as_tibble()

saveRDS(lrt.e.result, file.path(out.dir, 'enriched.lrt.result.rds'))
# lrt.e.result <- readRDS(file.path(out.dir, 'enriched.lrt.result.rds'))
```

## generate type-1 error curves

```{r generate_disease_enrichment_curves }
lrt.e.power <- lrt.e.result %>%
  mutate(
    lrt.p.val = ifelse(gamma < 0, 1, lrt.p.val),
    z.p.val = 1 - pnorm(z)
  ) %>%
  select(omega, lrt.p.val, z.p.val) %>%
  pivot_longer(cols = ends_with('p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(omega, test) %>%
  summarize(power = mean(p.val < 0.05))

lrt.e.power.sigmoid <- expand.grid(unique(lrt.e.power$test)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    power.df <- lrt.e.power[lrt.e.power$test == test,]
    my.sigmoid <- fit.sigmoid(power.df$omega, power.df$power, res.fit = 0.00001) %>%
      rename('omega' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.e.power$src <- 'data'
lrt.e.power.sigmoid$src <- 'fit'

compare.e.df <- bind_rows(
  lrt.e.power,
  lrt.e.power.sigmoid
)

test.e.colors <- c(
  'lrt' = '#f42e3d',
  'z' = '#2ff4e4'
)

power.e.plt <- (
  compare.e.df %>%
    ggplot(aes(x = omega, y = power / 0.05, color = test)) +
    scale_color_manual(values = test.e.colors) +
    geom_line(linewidth = 2/3,
              data = subset(compare.e.df, src == 'fit')
    ) +
    geom_point(size = 2,
               data = subset(compare.e.df, src == 'data')
    ) +
    # scale_shape_manual(values = c(
    #   '-0.4' = 16,
    #   '0' = 21
    # )) +
    # scale_linetype_manual(values = c('0' = 'dotted', '-0.4' = 'solid')) +
    # geom_hline(yintercept = wilcox.1t.power, linetype = 'dashed') +
    geom_hline(yintercept = 1, linetype = 'dotted') +
    geom_vline(xintercept = params.e$omega, linetype = 'dashed') +
    scale_x_continuous(
      limits = c(0.0002, 0.0012),
      breaks = seq(0.0002, 0.0012, by = 0.0002)
    ) +
    labs(
      x = expression(omega^'*'),
      y = 'Fold Increase in T1 Error',
      color = 'Test',
    )
) %>%
  save.plot('lrt.e.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.e.plt
```

# liability plot from prior results ####

## run sims

```{r run_liability_sims, cache=T}
source('../lrt_equations/equations.liabilityG.R')
list2env(lrt.liabilityG.equations, envir = environment())

f.lrt.liability <- function(params) {
  sim.result <- f.call(sim, params)
  
  lrt.cc <- run.mle(sim.result, params, cases.only = F)
  lrt.co <- run.mle(sim.result, params, cases.only = T)
   
  x <- data.frame(sim.result)
  
  fwd.p.val = lmtest::lrtest(
    lm(y ~ 1 + X + G + GX, data = x),
    lm(y ~ 1 + X, data = x)
  )[2,5]
  
  wilcox.p.val <- wilcox.test(
    X ~ G,
    data = x[x$y >= params$delta,],
    alternative = 'greater'
  )$p.value
  
  sim.result$Y <- sim.result$y >= params$delta # for z-test
  
  setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
    modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
  modifyList(
      list(
        fwd.p.val = fwd.p.val,
        wilcox.p.val = wilcox.p.val
      )
  )
  %>%
      modifyList(z.test(w = params$omega, sim.result))
}

params.liability <- list(
  n = 500000,
  omega = 0.001,
  alpha = 0,
  beta = 0.3,
  gamma = 0.0,
  eta = 0,
  delta = 1.33,
  sige = 1
)

gamma.liability.range <- seq(0.0, 1.2, length.out = 8)
eta.liability.range <- c(-0.4, 0)

n.liability.sims <- 1024

lrt.liability.ranges <- expand.grid(gamma = gamma.liability.range, eta = eta.liability.range)

lrt.liability.result.2 <- mapply(function(gamma, eta) {
  params.liability$gamma <- gamma
  params.liability$eta <- eta
  
  r <- run.lrt(f.lrt.liability, params.liability, n.sims = n.liability.sims)
  
  r$param.gamma <- gamma
  r$param.eta <- eta
  
  r
}, lrt.liability.ranges$gamma, lrt.liability.ranges$eta, SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

saveRDS(lrt.liability.result, file.path(out.dir, 'liability.lrt.result.rds'))
# lrt.liability.result <- readRDS(file.path(out.dir, 'liability.lrt.result.rds'))

# lrt.liabilityG.result <- lapply(
#   list.files('.data/liabilityG_1024_beta0.5_optim_v1/', full.names = T),
#   readRDS
#   ) %>%
#   bind_rows() %>%
#   arrange(gamma, eta)
```

## generate power curves

```{r}
lrt.liability.power <- lrt.liability.result %>%
  select(param.gamma, param.eta, ends_with('gamma'), ends_with('.p.val')) %>%
  mutate(
    cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(across(starts_with('param')), test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup() %>%
  filter(param.eta != 0.1) %>%
  filter(test != 'cc.lrt') %>%
  mutate(test = gsub('^co.', '', test))

lrt.liability.power.sigmoid <- expand.grid(
  unique(lrt.liability.power$test),
  unique(lrt.liability.power$param.eta)
) %>%
  apply(1, function(vals) {
    test <- vals[1]
    eta <- as.numeric(vals[2])
    power.df <- lrt.liability.power[
      lrt.liability.power$test == test &
        lrt.liability.power$param.eta == eta,]
    my.sigmoid <- fit.sigmoid(power.df$param.gamma, power.df$power,) %>%
      rename('param.gamma' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid$param.eta <- eta
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.liability.power$src <- 'data'
lrt.liability.power.sigmoid$src <- 'fit'

test.liability.colors <- c(
  'lrt' = '#f42e3d',
  'fwd' = '#2ff481',
  'wilcox' = '#e32ff4',
  'z' = '#2ff4e4'
)

compare.liability.df <- bind_rows(
  lrt.liability.power,
  lrt.liability.power.sigmoid
) %>%
  mutate(param.eta = as.factor(param.eta)) %>%
  filter(test %in% names(test.liability.colors))

power.liability.plt <- (
  compare.liability.df %>%
    ggplot(aes(x = param.gamma, y = power, color = test)) +
    scale_color_manual(values = test.liability.colors) +
    geom_line(aes(linetype = param.eta), linewidth = 2/3,
              data = subset(compare.liability.df, src == 'fit')
    ) +
    geom_point(aes(shape = param.eta), size = 2,
               data = subset(compare.liability.df, src == 'data')
    ) +
    scale_shape_manual(values = c(
      '0' = 16,
      '-0.4' = 21
    )) +
    scale_linetype_manual(values = c('-0.4' = 'dotted', '0' = 'solid')) +
    scale_x_continuous(
      limits = c(0, 1.2),
      breaks = seq(0, 1.2, by = 0.4)
    ) +
    labs(
      x = expression(gamma),
      y = 'Power',
      color = 'Test',
      shape = expression(eta),
      linetype = expression(eta),
    )
) %>%
  save.plot('lrt.liability.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.liability.plt
```



# save params object ####

```{r save_params}
list(
  logitG.params = unlist(params),
  liabilityG.params = unlist(params.liability),
  logitG.null.w.params = unlist(params.e),
  logitG.nonnull.w.params = unlist(params.o)
) %>%
  saveRDS(file.path(out.dir, 'power.params.rds'))
```


# compose 2x2 plot ####

```{r}
compose.theme <- theme_bw() +
  theme(
    # strip.text = element_text(face = "bold", size = 14),
    axis.text = element_text(face = "bold", size = 10),
    axis.title = element_text(face = "bold", size = 10),
    # legend.title = element_text(face = "bold", size = 11),
    # legend.text = element_text(size = 11),
    # legend.position = "none"
  )

small.x.text <- theme(
  axis.text.x = element_text(face = "bold", size = 8)
)

no.legend <- theme(
  legend.position = 'none'
)

(
  (
    (power.plt + compose.theme + power.liability.plt + compose.theme) /
      (power.e.plt + compose.theme + small.x.text + no.legend + power.o.plt + compose.theme + no.legend)
  ) +
    plot_layout(guides = 'collect') +
    plot_annotation(tag_levels = 'a', tag_suffix = ')')
) %>%
  save.plot('power.composed', root.dir = out.dir, w = 4.5 * 2.25, h = 4.5 * 2)
```


# save data ####

```{r save_data}
list(
  logitG.power = lrt.power,
  liabilityG.power = lrt.liability.power,
  t1e.power = lrt.e.power,
  overspec.power = lrt.o.power
) %>%
  saveRDS(file.path(out.dir, 'simulation.power.results.RDS'))
```


# supplemental logitG control contamination analysis ####

## re-load logitG equations

```{r reload_logitG_equations, message=F, results='hide'}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())
```

## run sims

```{r load_liabilityG_results, cache=T, cache.extra=file.info('.data/liabilityG_1024_beta0.5_optim_v1/')}
f.lrt.c <- function(params) {
  sim.result <- f.call(sim, params)
  
  Y1G1.idx <- which(sim.result$Y == 1 & sim.result$G == 1 )
  
  c.range <- c(0, 0.1, 0.25, 0.5, 0.9)
  
  a <- lapply(c.range, function(c.level) {
    contaminated.sim.result <- sim.result
    contaminated.idx <- sample(Y1G1.idx, floor(c.level * length(Y1G1.idx)))
    contaminated.sim.result$Y[contaminated.idx] <- 0
    
    x <- data.frame(contaminated.sim.result)
    
    lrt.co <- run.mle(contaminated.sim.result, params, cases.only = T)
    
    fwd.p.val <- lmtest::lrtest(
      glm(Y ~ 1 + X + G + GX, family = binomial(link = 'logit'), data = x),
      glm(Y ~ 1 + X, family = binomial(link = 'logit'), data = x)
    )[2,5]
     
    wilcox.p.val <- wilcox.test(
      X ~ G,
      data = x[x$Y==1,],
      alternative = 'greater'
    )$p.value
    
    r <- setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
      # modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
      modifyList(
        list(
          fwd.p.val = fwd.p.val,
          wilcox.p.val = wilcox.p.val
        )
      ) %>%
        modifyList(z.test(w = params$omega, contaminated.sim.result))
    
    r$c.lvl <- c.level
    r
  }) %>%
    do.call(bind_rows, .)
}

params.c <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  beta = 0.6,
  eta = -0.4,
  gamma = 0.6
)

n.c.sims <- 32

lrt.c.result <- run.lrt(f.lrt.c, params.c, n.sims = n.c.sims)

saveRDS(lrt.c.result, file.path(out.dir, 'c.lrt.result.rds'))
```

## generate power curves

```{r}
lrt.c.power <- lrt.c.result %>%
  select(c.lvl, ends_with('gamma'), ends_with('.p.val')) %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(test, c.lvl) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup()

lrt.c.power.sigmoid <- expand.grid(
  unique(lrt.c.power$test)
) %>%
  apply(1, function(vals) {
    test <- vals[1]
    power.df <- lrt.c.power[
      lrt.c.power$test == test,]
    my.sigmoid <- fit.sigmoid(power.df$c.lvl, power.df$power, res.fit = 0.05) %>%
      rename('c.lvl' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.c.power$src <- 'data'
lrt.c.power.sigmoid$src <- 'fit'

test.c.colors <- c(
  'wilcox' = '#e32ff4',
  'co.lrt' = '#f42e3d',
  'z' = '#2ff4e4',
  'fwd' = '#2ff481'
)

compare.c.df <- bind_rows(
  lrt.c.power,
  lrt.c.power.sigmoid
) %>%
  filter(test %in% names(test.c.colors))

power.c.plt <- (
  compare.c.df %>%
    ggplot(aes(x = c.lvl, y = power, color = test)) +
    scale_color_manual(values = test.c.colors) +
    geom_line(linewidth = 2/3,
              data = subset(compare.c.df, src == 'fit')
    ) +
    geom_point(size = 2,
               data = subset(compare.c.df, src == 'data')
    ) +
    # scale_shape_manual(values = c(
    #   '0' = 16,
    #   '-0.4' = 21
    # )) +
    # scale_linetype_manual(values = c('-0.4' = 'dotted', '0' = 'solid')) +
    scale_x_continuous(
      limits = c(0, 1),
      breaks = seq(0, 1, by = 0.25)
    ) +
    labs(
      x = 'Contamination Level',
      y = 'Power',
      color = 'Test',
    )
) %>%
  save.plot('lrt.c.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.c.plt
```