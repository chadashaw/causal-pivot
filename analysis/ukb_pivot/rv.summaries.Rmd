---
title: "Rare Variant Summaries"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  pdf_document:
    number_sections: yes
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
---

```{r rv_summaries_deps, include=F}
library(paletteer, quietly = T, warn.conflicts = F)
library(waffle, quietly = T, warn.conflicts = F)
source("utils/main.R")
source("utils/data.R")

rv.flags <- readRDS(file.path(OUT_DIR, 'rv.flags.rds'))
cohort.dfs <- readRDS(file.path(OUT_DIR, 'cohort.dfs.rds'))
rv.prs.df <- readRDS(file.path(OUT_DIR, 'rv.prs.df.rds'))

cohorts <- readRDS(file.path(DATA_DIR, 'cohorts.rds'))
gene.lkps <- readRDS(file.path(DATA_DIR, 'gene.lkps.rds'))
annotations <- readRDS(file.path(DATA_DIR, 'annotations.rds'))
cohort.lkps <- readRDS(file.path(DATA_DIR, 'cohort.lkps.rds'))
cohort.marks <- readRDS(file.path(DATA_DIR, 'cohort.marks.rds'))
rv.mtx <- readRDS(file.path(DATA_DIR, 'rv.mtx.rds'))
prs.sig.marker.ids <- readRDS(file.path(DATA_DIR, 'prs.sig.marker.ids.rds'))
```

## Create publishable variant Excel workbook

Export pathogenic rare variant data to Excel
for supplemental materials and analysis.

```{r}
rv.summary.path <- file.path(OUT_DIR, 'rv.summary.xlsx')
```


```{r export_excel, eval=!file.exists(rv.summary.path), warning=F, message=F}

local({
  all.mtx <- as.matrix(readRDS(file.path(DATA_DIR, 'geno.mtx.rds'))[,rv.flags$marker.id])
  wb <- openxlsx::createWorkbook()
  
  rv.summary.df <- annotations %>%
    inner_join(rv.flags, by = 'marker.id') %>%
    mutate(
      prs.assoc = marker.id %in% prs.sig.marker.ids,
      cohort.af = apply(rv.mtx, 2, mean)[match(marker.id, colnames(rv.mtx))],
    ) %>%
    select(
      `Marker` = marker.id,
      `Gene` = gene.x,
      `Transcript` = transcript,
      `Chrom` = chrom,
      `Position` = pos,
      `Ref` = ref,
      `Alt` = alt,
      `c.` = cchange,
      `a.` = achange,
      `gnomAD AF` = gnomad3.af_nfe,
      `UKB AF` = cohort.af,
      `ClinVar ID` = clinvar.allele_id,
      `Clinvar Significance` = clinvar.sig,
      `Clinvar Sign. Conflicting` = clinvar.sig_conf,
      `Revel` = revel.score,
      `CADD` = cadd_exome.phred,
      `RV Pos.` = class.positive,
      `Controls (Rare Synonymous)` = class.rare.synonymous,
      `PRS Assoc` = prs.assoc,
      `Selected RV Pos.` = pathogenic,
      `Selected Controls` = control,
      `Clinvar Pathogenic` = class.clinvar.pathogenic,
      `Rare` = class.rare,
      `Loss of Function` = class.loss.of.function,
      `Synonymous` = class.synonymous,
    )
  
  openxlsx::addWorksheet(wb, "Annotations")
  openxlsx::writeDataTable(wb, "Annotations", rv.summary.df)
  
  local({
    openxlsx::addWorksheet(wb, "PRS + Counts")
    
    process.variants <- function(my.cohort.name) {
      prs.name <- cohort.lkps$prs[[my.cohort.name]]
      df <- rv.prs.df[,c('sample.id', my.cohort.name, cohort.lkps$prs[[my.cohort.name]])] %>%
        magrittr::set_colnames(c('sample.id', 'case', 'prs')) %>%
        mutate(cohort = my.cohort.name) %>%
        filter(!is.na(case))
      
      summary.df <- pbapply::pbapply(all.mtx, 2, function(sample.gts) {
        df$gt <- sample.gts[df$sample.id]
        
        freq.df <-  df %>%
          group_by(case) %>%
          summarize(f = mean(gt)) %>%
          ungroup()
        
        prs.mean.df <- df %>%
          group_by(case) %>%
          filter(gt == 1) %>%
          summarize(prs.mean = mean(prs), n = n()) %>%
          ungroup() %>%
          inner_join(freq.df, by = 'case')
      }) %>%
        purrr::list_rbind(names_to = 'marker.id') %>%
        mutate(
          case = ifelse(case, 'case', 'control')
        ) %>%
        pivot_wider(id_cols = c('marker.id'), names_from = c('case'), values_from = c('prs.mean', 'f', 'n')) %>%
        mutate(
          cohort.name = my.cohort.name
        ) %>%
        select(
          `Marker` = 'marker.id',
          `Cohort` = 'cohort.name',
          `Mean PRS (Controls)` = 'prs.mean_control',
          `Mean PRS (Cases)` = 'prs.mean_case',
          `RV+ Count (Controls)` = 'n_control',
          `RV+ Count (Cases)` = 'n_case',
          `RV+ Frequency (Controls)` = 'f_control',
          `RV+ Frequency (Cases)` = 'f_case'
        ) %>%
        left_join(select(
          rv.summary.df,
          `Marker`,
          `Gene`,
          `RV Pos.`,
          `Controls (Rare Synonymous)`,
          `PRS Assoc`,
          `Selected RV Pos.`,
          `Selected Controls`,
          `Clinvar Pathogenic`,
          `Rare`,
          `Loss of Function`,
          `Synonymous`,
        ), by = 'Marker')
    }
    
    first.written <- F
    n.written <- 0
    for (my.cohort.name in names(cohorts)) {
      my.df <- process.variants(my.cohort.name)
      if (!first.written) {
        openxlsx::writeDataTable(wb, "PRS + Counts", my.df[0,])
        first.written <- T
      }
      openxlsx::writeData(wb, "PRS + Counts", my.df, startRow = 2 + n.written, colNames = F)
      n.written <- n.written + nrow(my.df)
    }
  })
  
  openxlsx::saveWorkbook(wb, rv.summary.path, overwrite = T)
})
```

## Plot variant classification summaries

### Variant mutation type waffle plot

Plot pathogenic rare variants by sequence ontology.

A waffle plot gives an intuitive feel for proportion of variants by sequence ontology.
This heterogeneity indicates signals are not dominated by a single mutation type (`MT`).

```{r plot_variant_mutation_type_waffle, warning=F, message=F}
# create positive variants data frame w/ mutation types ####

mt.df <- left_join(
  filter(rv.flags, pathogenic),
  select(annotations, marker.id, mutation.type),
  by = 'marker.id'
) %>%
  mutate(mutation.type = as.factor(snakecase::to_title_case(mutation.type))) %>%
  group_by(gene, mutation.type) %>%
  summarize(n = n())  %>%
  ungroup() %>%
  mutate(gene = factor(gene, levels = gene.lkps$grp.to.genes))

# create plot ####

# get sorted list of mutation type by most common - used to make color palette
mt.palette <- paletteer_d(
    "ggthemes::Classic_20",
    n = length(levels(mt.df$mutation.type))
  ) %>%
  purrr::set_names(levels(mt.df$mutation.type))

(
  mt.df %>%
    ggplot(aes(fill = mutation.type, values = n)) +
    geom_waffle(size = 0.33, colour = "white") +
    coord_equal() +
    facet_wrap(~gene) +
    labs(fill = 'Sequence Ontology') +
    theme_void(base_family="Arial") +
    theme(
      plot.background = element_rect(fill = "white", color = NA),
      # axis.text = element_text(size=8),
      # axis.title = element_text(size=8, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      # plot.margin = ggplot2::margin(0.25),
      legend.key.width = unit(0.8, "lines"),
      legend.key.height = unit(0.8, "lines"),
      axis.title.x = element_blank()
    )
) %>%
  save.plot('supp.fig5', w = 4.5, h = 4.5 * 9 / 16, root.dir = PLOTS_DIR, sub.dir = 'supplementary')

saveRDS(mt.df, file.path(OUT_DIR, 'rv.mutation.type.rds'))
```

### Variant spread hisogram

Plot histogram summarizing variant mutation type
and how variants are distributed among cohorts.
The x axis is the number of samples in which a variant appears:

  - bars to the left are rarer variants
  - bars to the right are more common

The `max` annotation is the maximum number of samples in which a single
positive variant appears.

This plot further shows the causal pivot signal is not carried by a single
functional type.

```{r plot_variant_spread_histogram, warning=F, message=F}
# create dataframe counting positive samples per variants w/ SO annotation ####

cases <- rv.prs.df %>% filter((!is.na(HC190) & HC190) | (!is.na(BC) & BC) | (PD & !is.na(PD))) %>% pull(sample.id)

alt.counts <- alt.sums.by.sample(rv.mtx, cohort.marks) %>%
  mtx.to.df('cohort', 'marker.id', 'alt.count') %>%
  left_join(select(annotations, marker.id, gene, mutation.type), by = 'marker.id') %>%
  mutate(mutation.type = as.factor(snakecase::to_title_case(mutation.type))) %>%
  rowwise() %>%
  filter(gene %in% cohorts[[cohort]]$genes) %>%
  ungroup() %>%
  mutate(cohort = factor(cohort, levels = names(cohort.dfs)))

# calculate maximum number of count groups per cohort - used to place label
max.n <- alt.counts %>%
  group_by(cohort) %>%
  count(alt.count) %>%
  summarize(max.n = max(n)) %>%
  ungroup()

# create count group aggregation dataframe used for annotation
max.counts <- alt.counts %>%
  group_by(cohort) %>%
  summarize(max.count = max(alt.count)) %>%
  left_join(max.n, by = 'cohort') %>%
  rowwise() %>%
  mutate(label = paste("Max: ", max.count)) %>%
  ungroup()

# generate actual plot and save
mt.newline.palette <- mt.palette
names(mt.newline.palette) <- gsub(' ', '\n', names(mt.newline.palette))
mt.dist <- (
  alt.counts %>%
  mutate(
    n.samples = factor(ifelse(alt.count > 5, ">5", as.character(alt.count)), levels = c("1", "2", "3", "4", "5", ">5")),
  ) %>%
  group_by(cohort, mutation.type, n.samples) %>%
  summarize(n.markers = n()) %>%
  mutate(
    mutation.type = gsub(' ', '\n', mutation.type)
  ) %>%
  ggplot(aes(x = n.samples, y = n.markers)) +
  geom_col(aes(fill = mutation.type), color = "white", linewidth = 0.53) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  scale_fill_manual(values = mt.newline.palette) +
  facet_wrap(~cohort, scales='free_y') +
  labs(
    x = 'Sample Counts',
    y = 'Num Markers',
    # title = paste("Variant Distribution Histogram w/ Sequence Ontology"),
    title = '',
    fill = "Mutation Type"
  ) +
  theme_bw(base_family="Arial") +
  theme(
    panel.grid = element_blank(),
    axis.title = element_text(face = 'bold', size = 8),
    axis.text = element_text(face = 'bold', size = 7),
    strip.text = element_text(face = 'bold', size = 8),
    legend.title = element_text(size = 8),
    strip.background = element_rect(fill = "white")
  ) +
  geom_label(
    data = max.counts,
    aes(label = label, y = max.n),
    x = 4,
    size = 6,
    size.unit = "pt",
    # color = "black",
    # fill = "white",
    # label.size = NA
  )
) %>%
  save.plot(
    'fig3B',
    root.dir = PLOTS_DIR,
    sub.dir = 'misc',
    w = 6.5,
    h = 4.5
  )

mt.dist
# save results ####

# create useful rv count summary
rv.counts <- alt.counts %>%
  group_by(cohort, gene, alt.count) %>%
  summarize(n = n())

saveRDS(mt.dist, file = file.path(DATA_DIR, 'mt.dist.rds'))
saveRDS(alt.counts, file = file.path(OUT_DIR, 'alt.counts.rds'))
saveRDS(rv.counts, file = file.path(OUT_DIR, 'rv.counts.rds'))
```