---
title: "Causal Pivot Analysis"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  pdf_document:
    number_sections: yes
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
---

```{r chunk_opts, include=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = F,
  fig.align = "center"
)
```

# Causal Pivot Analysis - Introduction

This document contains code and comments for the primary analysis of the
presence of a causal pivot between two independent causal factors of disease:

 - Pathogenic Rare Variant Events (RV) - a binary variable
 - Polygenic Risk Scores (PRS) - a continuous variable
 
3 disease cohorts from the UK Biobank (UKB), and associated causative genes are defined:

 - Hypercholesterolemia & LDLR
 - Breast Cancer & BRCA1
 - Parkinson's & GBA
 
Each cohort/gene is paired with the "standard" version of the UKB PRS for that disease.

Running the code step-by-step and reading the comments should be the simplest
way to understand the analysis.

The analysis proceeds as follows:

 #. partition UKB samples into sub-cohorts based on disease metadata
 #. classify rare/pathogenic variants
 #. adjust for population-wide dependence b/w rare variant status and PRS
 #. create binary rare event variables
 #. investigate causal collider via plots and statistics
 #. investigate presence of collider signal after controlling for ancestry
 #. perform supplemental "genetic load" analysis in Parkinson's
  - the Lysosomal Storage Disease (LSD) gene list is required and read from
`LSD_human_genes.txt` in `SRC_DATA_DIR`.

# Globals

```{r globals}
# if NULL or empty, will use UKB
PRS_SOURCE <- NULL
RESULTS_DIR <- "./.data/results/pivot-ukb/"
# PRS_SOURCE <- "./.data/prs/big3.scores.txt.gz"
# RESULTS_DIR <- "./.data/results/pivot-big3/"

# set source and result data dirs from environment ####
SRC_DATA_DIR <- Sys.getenv("SRC_DATA_DIR")

# set and create results directories ####

OUT_DIR <- file.path(RESULTS_DIR, 'out') # for primary raw data results
PLOTS_DIR <- file.path(RESULTS_DIR, 'plots') # for plots
DATA_DIR <- file.path(RESULTS_DIR, 'data') # for intermediates

dir.create(DATA_DIR, showWarnings = F, recursive = T)
dir.create(PLOTS_DIR, showWarnings = F, recursive = T)
dir.create(OUT_DIR, showWarnings = F, recursive = T)

# load gene list for Parkinson's LSD genetic burden analysis
lsd.genes <- readLines(file.path(SRC_DATA_DIR, 'LSD_human_genes.txt'))
```

# Setup

```{r child="setup.Rmd"}
```

# Rare Variant Summaries

```{r child="rv.summaries.Rmd"}
```

# Perform MLE Permutation Testing

```{r include=F}
n.mle.perms <- 8
```

```{r child="lrt.Rmd"}
```

<!-- # Plot Collider Effect -->

<!-- ```{r, child = "collider.plots.Rmd"} -->
<!-- ``` -->

<!-- # Perform Ancestry Confounder Control Analysis -->

<!-- ```{r, child="ancestry.control.Rmd"} -->
<!-- ``` -->

<!-- # Supplementary LSD/PD "Genetic Load" Analysis -->

<!-- ```{r, child="genetic.burden.Rmd"} -->
<!-- ``` -->

<!-- # Supplementary Age Selection Bias Analysis -->
<!-- ```{r selection_bias, eval=F} -->
<!-- yob.df <- fread(file.path(SRC_DATA_DIR, "cohort.meta.tsv"), sep="\t", header=T)  %>% -->
<!--   mutate( -->
<!--     sample.id = paste(`Participant ID`, `Participant ID`, sep='_'), -->
<!--     yob = `Year of birth`, -->
<!--   ) %>% -->
<!--   select(sample.id, yob) -->

<!-- bias.df <- cohort.meta %>% -->
<!--   select(sample.id, age, pd.rep.date, starts_with('bc.inst')) %>% -->
<!--   # select(sample.id, age) %>% -->
<!--   filter(!is.na(age)) -->

<!-- hc190.bias.cases.df <- cohort.dfs$HC190 %>% -->
<!--   filter(case) %>% -->
<!--   inner_join(bias.df, by = 'sample.id') -->

<!-- bc.bias.cases.df <- cohort.dfs$BC %>% -->
<!--   filter(case) %>% -->
<!--   inner_join(bias.df, by = 'sample.id') -->

<!-- pd.bias.cases.df <- cohort.dfs$PD %>% -->
<!--   filter(case) %>% -->
<!--   inner_join(bias.df, by = 'sample.id') %>% -->
<!--   left_join(yob.df, by = 'sample.id') %>% -->
<!--   mutate(age.of.onset = as.integer(format(pd.rep.date, "%Y")) - yob) %>% -->
<!--   mutate(age = age.of.onset) -->

<!-- surv.plot <- function(df, lbl = '') { -->
<!--   my.survdiff <- survdiff(Surv(age, case) ~ rv, data = df) -->
<!--   my.survfit <- survfit(Surv(age, case) ~ rv, data = df) -->
<!--   survfit.df <- with(my.survfit, -->
<!--     data.frame( -->
<!--       time = time, -->
<!--       surv = surv, -->
<!--       lower = lower, -->
<!--       upper = upper, -->
<!--       censor = n.censor > 0, -->
<!--       strata = rep(names(strata), strata) -->
<!--     ) -->
<!--   ) -->

<!--   survfit.df %>% -->
<!--     ggplot(aes(x = time, y = surv, color = strata)) + -->
<!--     geom_step() + -->
<!--     # geom_point(data = subset(survfit.df, censor), aes(x = time, y = surv), shape=3) -->
<!--     geom_ribbon(aes(ymin = lower, ymax = upper, fil = strata), alpha = 0.2) + -->
<!--     labs( -->
<!--       title = paste("P(Undiagnosed) vs. Age", lbl, sep = " - "), -->
<!--       subtitle = paste("p.val:", my.survdiff$pvalue), -->
<!--       x = "Age", -->
<!--       y = "P(Undiagnosed)", -->
<!--     ) -->
<!-- } -->

<!-- surv.plot(hc190.bias.cases.df, 'HC190/LDLR_Clinvar') -->
<!-- surv.plot(bc.bias.cases.df, 'BC/BRCA1_Clinvar') -->
<!-- surv.plot(pd.bias.cases.df, 'PD/GBA_Clinvar') -->

<!-- broom::tidy(lm(prs ~ age, data = hc190.bias.cases.df)) -->
<!-- broom::tidy(lm(prs ~ age, data = bc.bias.cases.df)) -->
<!-- broom::tidy(lm(prs ~ age, data = pd.bias.cases.df)) -->

<!-- plot(hc190.bias.cases.df$age, hc190.bias.cases.df$prs) -->
<!-- plot(bc.bias.cases.df$age, bc.bias.cases.df$prs) -->
<!-- plot(pd.bias.cases.df$age, pd.bias.cases.df$prs) -->


<!-- hc190.bias.cases.df <- cohort.dfs$HC190 %>% -->
<!--   inner_join(bias.df, by = 'sample.id') -->

<!-- broom::tidy(glm(case ~ rv * prs, family = binomial(link = 'logit'), data = hc190.bias.cases.df)) -->

<!-- hc190.bias.cases.df -->

<!-- # cohort.df <- cohort.dfs$BC -->
<!-- # gene.grp <- 'BRCA1' -->
<!-- cohort.df <- cohort.dfs$PD -->
<!-- gene.grp <- 'GBA' -->
<!-- G.df <- rv.prs.df[c('sample.id', gene.grp)] %>% -->
<!--   magrittr::set_colnames(c('sample.id', 'G')) -->
<!-- lrt.df <- cohort.df %>% -->
<!--   left_join(G.df, by = 'sample.id') %>% -->
<!--   mutate( -->
<!--     Y = as.integer(case), -->
<!--     G = as.integer(G), -->
<!--     X = prs -->
<!--   ) %>% -->
<!--   select(sample.id, Y, X, G) %>% -->
<!--   inner_join(bias.df, by = 'sample.id') -->

<!-- # calculate forward model parameter "targets" -->
<!-- broom::tidy(glm(Y ~ G * X, family = binomial(link = 'logit'), data = lrt.df)) -->
<!-- broom::tidy(glm(Y ~ G * X + age, family = binomial(link = 'logit'), data = lrt.df)) -->
<!-- broom::tidy(glm(Y ~ G * X * age, family = binomial(link = 'logit'), data = lrt.df)) -->
<!-- ``` -->

