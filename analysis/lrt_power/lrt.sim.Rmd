---
title: "Causal Pivot Power Analysis"
author: "CJ Williams"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"

output:
  html_document:
    number_sections: yes
    toc: yes
    
knitr:
  opts_chunk:
    cache: true
    cache.path: ".data/cache"
---

# Causal Pivot Power Analysis

We investigate the power properties of the causal pivot likelihood ratio test (lrt)
under the logistic (logitG) and liability (liabilityG) models.
We relate the power of these tests to other comparators including forward
logistic regression, cases-only reverse logistic regression, z-tests and Man-Whitney-Wilcox tests.
We further investigate the robustness of our tests to overestimation and underestimation of
allele frequency (omega) values for data sets with and without an effect from G to Y (respectively)


```{r load_libraries, echo = F, message = F, warning = F}
library(parallel, quietly = T, warn.conflicts = F)
library(lmtest, quietly = T, warn.conflicts = F)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(patchwork)

source('utils.R')
```

# Define Helpers

```{r}
# create list to store analysis results
lrt.analyses <- list()
  
test.labels <- c(
  # 'cc.lrt' = 'Case-Control LRT',
  'co.lrt' = 'CP LRT',
  'fwd' = 'Forward Regression',
  'wilcox' = 'Wilcoxon',
  'z' = 'Z'
)

test.labels <- setNames(stringr::str_wrap(test.labels, width = 8), names(test.labels))

test.colors <- c(
  # 'cc.lrt' = '#2f2ff4',
  'co.lrt' = '#f42e3d',
  'fwd' = '#2ff481',
  'wilcox' = '#e32ff4',
  'z' = '#2ff4e4'
)

lbl.colors <- setNames(test.colors[names(test.labels)], test.labels)

create.power.df <- function(lrt.runs, ranged.params) {
  if ('cc.lrt.p.val' %in% names(lrt.runs)) {
    lrt.runs <- lrt.runs %>%
      mutate(cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val))
  }
  
  if ('co.lrt.p.val' %in% names(lrt.runs)) {
    lrt.runs <- lrt.runs %>%
      mutate(co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val))
  }
  
  lrt.runs %>%
    select(all_of(ranged.params), ends_with('.p.val')) %>%
    pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
    mutate(test = gsub('.p.val', '', test)) %>%
    group_by(across(starts_with('param')), test) %>%
    summarize(power = mean(p.val < 0.05)) %>%
    ungroup()
}

create.power.sigmoid <- function(power.df, x.param.name, sigmoid.res) {
  sigmoid.grid <- as.list(names(power.df)[grepl('^param\\.', names(power.df))]) %>%
    purrr::keep(~ . != x.param.name) %>%
    purrr::set_names() %>%
    purrr::map(~ unique(power.df[[.]])) %>%
    modifyList(list(test = unique(power.df$test)), .) %>%
    expand.grid()
  
  # there's gotta be a better way to iter df rows
  sigmoid.grid %>%
    purrr::pmap(function(...) {
      params.subset <- list(...) # this hack let's me "apply" w/o converting to matrix and losing types
      sub.power.idxs <- purrr::map2(names(params.subset), params.subset, ~ power.df[[.x]] == .y) %>% purrr::reduce(`&`)
      sub.power.df <- power.df[sub.power.idxs,]
      col.lkp <- setNames(c('x', 'y'), c(x.param.name, 'power'))
      fit.sigmoid(sub.power.df[[x.param.name]], sub.power.df$power, res.fit = sigmoid.res) %>%
        rename(all_of(col.lkp)) %>%
        modifyList(as.list(params.subset))
    }) %>%
    do.call(bind_rows, .) %>%
    as_tibble()
}

augment.sigmoid <- function(power.df, x.param.name, sigmoid.res = 0.01) {
  power.sigmoid <- create.power.sigmoid(power.df, x.param.name, sigmoid.res)

  power.df$src <- 'data'
  power.sigmoid$src <- 'fit'
  
  bind_rows(
    power.df,
    power.sigmoid
  ) %>%
    mutate(across(
      .cols = starts_with('param.') & !all_of(c(x.param.name)),
      .fns = ~ as.factor(.)
    ))
}
```


# LogitG LRT + Comparator Power Analysis ####

## run sims

```{r execute_logitG_lrt_sims, cache=T}
sim.run.dir <- '.data/sim_runs/random_test/'
tmp.files <- dir(sim.run.dir)
logitG.lrt.runs <- tmp.files[grepl('64.rds$', tmp.files)] %>%
  purrr::map(~ readRDS(file.path(sim.run.dir, .x))) %>%
  purrr::map(~ .x$lrt.result) %>%
  purrr::list_rbind()

logitG.power.df <- create.power.df(logitG.lrt.runs, c('param.gamma', 'param.eta'))
saveRDS(logitG.power.df, file.path(out.dir, 'logitG.power.df.rds'))
```

## generate power curve

```{r generate_main_power_curve}
logitG.compare.df <- augment.sigmoid(logitG.power.df, 'param.gamma') %>%
  mutate(
    test = factor(test.labels[test], levels = test.labels),
  )

logitG.power.plt <- (
  logitG.compare.df %>%
    ggplot(aes(x = param.gamma, y = power, color = test)) +
    scale_color_manual(values = lbl.colors, name = NULL) +
    geom_line(aes(linetype = param.eta), linewidth = 0.53,
      data = subset(logitG.compare.df, src == 'fit')
    ) +
    geom_point(aes(shape = param.eta), size = 1,
      data = subset(logitG.compare.df, src == 'data')
    ) +
    scale_shape_manual(values = c(
      '-0.4' = 21,
      '0' = 16
    )) +
    scale_x_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, by = 0.2)) +
    scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
    labs(
      x = expression(gamma),
      y = 'Power',
      color = 'Test',
      shape = expression(eta),
      linetype = expression(eta),
    ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.8, 0.6),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(0, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 1, 1, 1)
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
)

(
  logitG.power.plt
  # +
  #   theme(legend.position = "none")
) %>%
  save.plot('fig2.panelA.main', root.dir = out.dir, w = 3, h = 3)

# (
#   cowplot::ggdraw(cowplot::get_legend(logitG.power.plt + theme(legend.position="right")))
# ) %>%
#   save.plot('fig2.panelA.legend', root.dir = out.dir, w = 2.875, h = 2.875)

logitG.power.plt
```

# disease enrichment type 1 error ####

## run sims

```{r run_disease_enrichment_sims, cache=T}
e.sim.run.dir <- '.data/sim_runs/fig2B/'
e.sim.runs <- dir(e.sim.run.dir) %>%
  .[grepl('fig2B', .)] %>%
  purrr::map(~ readRDS(file.path(e.sim.run.dir, .x)))

params.e <- e.sim.runs[[1]]$params

e.lrt.runs <- e.sim.runs %>%
  purrr::map(~ .x$lrt.result) %>%
  purrr::list_rbind()

lrt.e.power <- lrt.e.result %>%
  mutate(
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val),
    z.p.val = 1 - pnorm(z)
  ) %>%
  select(omega, co.lrt.p.val, z.p.val) %>%
  pivot_longer(cols = ends_with('p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(omega, test) %>%
  summarize(power = mean(p.val < 0.05))
saveRDS(lrt.e.power, file.path(out.dir, 'enriched.lrt.power.rds'))
```

## generate type-1 error curves

```{r generate_disease_enrichment_curves }
lrt.e.power.sigmoid <- expand.grid(unique(lrt.e.power$test)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    power.df <- lrt.e.power[lrt.e.power$test == test,]
    my.sigmoid <- fit.sigmoid(power.df$omega, power.df$power, res.fit = 0.00001) %>%
      rename('omega' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.e.power$src <- 'data'
lrt.e.power.sigmoid$src <- 'fit'

compare.e.df <- bind_rows(
  lrt.e.power,
  lrt.e.power.sigmoid
) %>%
  mutate(
    test = factor(test.labels[test], levels = test.labels),
  )

power.e.plt <- (
  compare.e.df %>%
    ggplot(aes(x = omega, y = power / 0.05, color = test)) +
    scale_color_manual(values = lbl.colors, name = NULL) +
    geom_line(linewidth = 0.53,
              data = subset(compare.e.df, src == 'fit')
    ) +
    geom_point(size = 1,
               data = subset(compare.e.df, src == 'data')
    ) +
    # scale_shape_manual(values = c(
    #   '-0.4' = 16,
    #   '0' = 21
    # )) +
    # scale_linetype_manual(values = c('0' = 'dotted', '-0.4' = 'solid')) +
    # geom_hline(yintercept = wilcox.1t.power, linetype = 'dashed') +
    geom_hline(yintercept = 1, linetype = 'dotted', linewidth = 0.53) +
    geom_vline(xintercept = params.e$omega, linetype = 'dashed', linewidth = 0.53) +
    scale_x_continuous(
      limits = c(0.0002, 0.0012),
      breaks = seq(0.0002, 0.0012, by = 0.0002)
    ) +
    labs(
      x = expression(omega^'*'),
      y = 'Fold Increase in T1 Error',
      # color = 'Test',
    ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.8, 0.9),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(0, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 1, 1, 0.25)
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
) %>%
  save.plot('fig2.panelB.main', root.dir = out.dir, w = 3, h = 3)

power.e.plt
```


# Mis-specified Omega Power - non-null ####

## run sims

```{r run_misspec_omega_sims, cache=T}
o.sim.run.dir <- '.data/sim_runs/fig2C/'
o.sim.runs <- dir(o.sim.run.dir) %>%
  .[grepl('fig2C', .)] %>%
  purrr::map(~ readRDS(file.path(o.sim.run.dir, .x)))

o.params <- o.sim.runs[[1]]$params

o.lrt.runs <- o.sim.runs %>%
  purrr::map(~ .x$lrt.result) %>%
  purrr::list_rbind()

o.power.df <- create.power.df(o.lrt.runs, c('param.omega'))
# lrt.o.result <- readRDS(file.path(out.dir, 'overestimation.lrt.result.rds'))
```

## generate power curves

```{r generate}
o.compare.df <- augment.sigmoid(o.power.df, 'param.omega', sigmoid.res = 0.00005) %>%
  mutate(
    test = factor(test.labels[test], levels = test.labels),
  )

o.power.plt <- (
  o.compare.df %>%
  ggplot(aes(x = param.omega, y = power, color = test)) +
  scale_color_manual(values = lbl.colors, name = NULL) +
  geom_line(linewidth = 0.53,
    data = subset(o.compare.df, src == 'fit')
  ) +
  geom_point(size = 1,
    data = subset(o.compare.df, src == 'data')
  ) +
  # scale_shape_manual(values = c(
  #   '-0.4' = 16,
  #   '0' = 21
  # )) +
  # scale_linetype_manual(values = c('0' = 'dotted', '-0.4' = 'solid')) +
  # geom_hline(yintercept = wilcox.1t.power, linetype = 'dashed') +
  geom_vline(xintercept = o.params$omega, linetype = 'dashed', linewidth = 0.53) +
  geom_vline(xintercept = median(o.lrt.runs$o), linetype = 'dotted', linewidth = 0.53) +
  scale_x_continuous(
    limits = c(0.001, 0.006),
    breaks = seq(0.001, 0.006, by = 0.001)
  ) +
  labs(
    x = expression(omega^'*'),
    y = 'Power',
  ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.825, 0.9),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(0, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 0.5, 1, 0.25),
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
) %>%
  save.plot('fig2.panelC.main', root.dir = out.dir, w = 3, h = 3)

o.power.plt
```


# Main LRT + Low Beta & Overestimate Omega Analysis ####

## run sims

```{r execute_beta_lrt_sims, cache=T}
b.sim.run.dir <- '.data/sim_runs/fig2D.2/'
b.sim.runs <- dir(b.sim.run.dir) %>%
  .[grepl('fig2D.2', .)] %>%
  purrr::map(~ readRDS(file.path(b.sim.run.dir, .x)))

b.params <- b.sim.runs[[1]]$params

lrt.result.beta <- b.sim.runs %>%
  purrr::map(~ .x$lrt.result) %>%
  purrr::list_rbind()


lrt.power.beta <- lrt.result.beta %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  select(param.gamma, param.beta, ends_with('.p.val')) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(across(starts_with('param')), test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup()

saveRDS(lrt.power.beta, file.path(out.dir, 'beta.lrt.power.rds'))
```

## generate power curve

```{r generate_beta_power_curve}
lrt.power.beta.sigmoid <- expand.grid(unique(lrt.power.beta$test), unique(lrt.power.beta$param.beta)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    param.beta <- as.numeric(vals[2])
    power.df <- lrt.power.beta[
      lrt.power.beta$test == test & lrt.power.beta$param.beta == param.beta,
    ]
    my.sigmoid <- fit.sigmoid(power.df$param.gamma, power.df$power, res.fit = 0.01) %>%
      rename('param.gamma' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid$param.beta <- param.beta
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.power.beta$src <- 'data'
lrt.power.beta.sigmoid$src <- 'fit'

compare.df.beta <- bind_rows(
  lrt.power.beta,
  lrt.power.beta.sigmoid
) %>%
  mutate(
    param.beta = as.factor(param.beta),
    test = factor(test.labels[test], levels = test.labels)
)

f.scale.x <- function(x) sprintf("%.3f", x)
power.plt.beta <- (
  compare.df.beta %>%
  ggplot(aes(x = param.gamma, y = power, color = test)) +
  scale_color_manual(values = lbl.colors, name = NULL) +
  geom_line(aes(linetype = param.beta), linewidth = 0.53,
    data = subset(compare.df.beta, src == 'fit')
  ) +
  geom_point(aes(shape = param.beta), size = 1,
    data = subset(compare.df.beta, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '0.1' = 21,
    '0.3' = 15,
    '0.5' = 16
  )) +
  scale_linetype_manual(values = c('0.5' = 'solid', '0.3' = 'dashed', '0.1' = 'dotted')) +
  scale_x_continuous(
    limits = c(0, max(lrt.power.beta$param.gamma)),
    breaks = seq(0, max(lrt.power.beta$param.gamma), length = 7),
    labels = f.scale.x
  ) +
  labs(
    x = expression(gamma),
    y = 'Power',
    color = 'Test',
    shape = expression(beta),
    linetype = expression(beta),
  ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.2, 0.7),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(1/3, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 1, 1, 1),
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
) %>%
  save.plot('fig2.panelD.main', root.dir = out.dir, w = 3, h = 3)

power.plt.beta
```


# compose 2x2 plot ####

```{r}
fig2.A <- logitG.power.plt
fig2.B <- power.e.plt
fig2.C <- o.power.plt
fig2.D <- power.plt.beta

(
  (
    (fig2.A + fig2.B) /
      (fig2.C + fig2.D)
  ) +
    # plot_layout(guides = 'collect') +
    plot_annotation(tag_levels = 'A', tag_suffix = ')')
) %>%
  save.plot('fig2', root.dir = out.dir, w = 6.5, h = 6.5)
```

# Model Including Confounder (A) ####

## run sims

```{r execute_confounder_lrt_sims, cache=T}
a.sim.run.dir <- '.data/sim_runs/supp.logitG_A/'
a.sim.runs <- dir(a.sim.run.dir) %>%
  .[grepl('supp.logitG_A', .)] %>%
  purrr::map(~ readRDS(file.path(a.sim.run.dir, .x)))

a.params <- a.sim.runs[[1]]$params

logitG_A.lrt.runs <- a.sim.runs %>%
  purrr::map(~ .x$lrt.result) %>%
  purrr::list_rbind()

logitG_A.power.df <- create.power.df(logitG_A.lrt.runs, c('param.gamma', 'param.eta'))

saveRDS(logitG_A.power.df, file.path(out.dir, 'logitG_A.power.df.rds'))
# f.lrt(modifyList(params, list(gamma = 1.2, eta = -0.1)))
```

## generate power curve

```{r generate_logitG_A_power_curve}
logitG_A.compare.df <- augment.sigmoid(logitG_A.power.df, 'param.gamma') %>%
  mutate(
    test = factor(test.labels[test], levels = test.labels)
  )

# (
#   logitG_A.power.df %>%
#   filter(test %in% c('co.lrt')) %>%
#   mutate(param.kappa = as.factor(param.kappa)) %>%
#   ggplot(aes(x = param.zeta, y = power, color = test)) +
#   scale_color_manual(values = test.colors) +
#   # geom_line(aes(linetype = param.kappa), linewidth = 2/3,
#   #   data = subset(logitG_A.compare.df, src == 'fit')
#   # ) +
#   geom_point(aes(shape = param.kappa), size = 2) +
#   scale_shape_manual(values = c(
#     '0' = 21,
#     '1' = 16
#   )) +
#   # scale_linetype_manual(values = c('1' = 'solid', '-1' = 'dotted')) +
#   # scale_x_continuous(limits = c(0, 2), breaks = seq(0, 2, by = 0.2)) +
#   labs(
#     x = expression(zeta),
#     y = 'Power',
#     color = 'Test',
#     shape = expression(kappa),
#     linetype = expression(kappa),
#   )
# ) %>%
#   save.plot('lrt.logitG_A.power', root.dir = out.dir, w = 4.5, h = 4.5)

(
  logitG_A.compare.df %>%
  ggplot(aes(x = param.gamma, y = power, color = test)) +
  scale_color_manual(values = lbl.colors) +
  geom_line(aes(linetype = param.eta), linewidth = 2/3,
    data = subset(logitG_A.compare.df, src == 'fit')
  ) +
  geom_point(aes(shape = param.eta), size = 2,
    data = subset(logitG_A.compare.df, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '-0.4' = 21,
    '0' = 16
  )) +
  scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
  scale_x_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, by = 0.2)) +
  labs(
    x = expression(gamma),
    y = 'Power',
    color = 'Test',
    shape = expression(eta),
    linetype = expression(eta),
  ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.7, 0.6),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(1/3, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 1, 1, 1),
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
) %>%
  save.plot(
    'supp.fig10',
    root.dir = out.dir,
    sub.dir = 'supplemental',
    w = 3.346457,
    h = 3.346457
  )
```


# Compare LogitG and LogitG_A

```{r power_compare_logitG_logitG_A}
compare.df <- inner_join(logitG.compare.df, logitG_A.compare.df, by = c('param.gamma', 'param.eta', 'test', 'src'), suffix = c('.logitG', '.logitG_A')) %>%
  pivot_longer(cols = starts_with('power'), names_to = 'model', values_to = 'power') %>%
  mutate(model = gsub('power\\.', '', model))
  
compare.df <- compare.df %>%
  filter(test == 'CP LRT') %>%
  mutate(model = case_when(
    model == 'logitG' ~ 'f(G|X,Y)',
    model == 'logitG_A' ~ 'f(G|X1,X2,Y)',
    .default = NULL
  ))

(
  compare.df %>%
  ggplot(aes(x = param.gamma, y = power, color = model)) +
  geom_line(aes(linetype = param.eta), linewidth = 2/3,
    data = subset(compare.df, src == 'fit')
  ) +
  geom_point(aes(shape = param.eta), size = 2,
    data = subset(compare.df, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '-0.4' = 21,
    '0' = 16
  )) +
  scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
  scale_x_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, by = 0.2)) +
  # facet_wrap(~test) +
  labs(
    x = expression(gamma),
    y = 'Power',
    color = 'Model',
    shape = expression(eta),
    linetype = expression(eta),
  ) +
    theme_bw(base_family="Arial") +
    theme(
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
      # axis.line = element_blank(),
      # axis.line.x.bottom = element_line(color="black"),
      # axis.line.y.left = element_line(color="black"),
      axis.text = element_text(size=8),
      axis.title.y = element_text(size=8, family = "Arial", face = "bold"),
      axis.title.x = element_text(size=10, family = "Arial", face = "bold"),
      legend.text = element_text(size=6),
      legend.title = element_text(size=8),
      legend.position = c(0.7, 0.6),
      # legend.justification = c(1, 0),
      legend.background = element_rect(fill = "white"),
      legend.spacing.y = unit(1/3, "cm"),
      legend.key.height = unit(0.5, "lines"),
      legend.margin = margin(1, 1, 1, 1),
    ) +
    guides(
      color = guide_legend(order = 1),
      shape = guide_legend(order = 2),
      linetype = guide_legend(order = 2)
    )
) %>%
  save.plot(
    'compare.lrt.power',
    root.dir = out.dir,
    w = 3.346457,
    h = 3.346457
  )
```



# liability analysis ####

## run sims

```{r run_liability_sims, cache=T}
source('../lrt_equations/equations.liabilityG.R')
list2env(lrt.liabilityG.equations, envir = environment())

f.lrt.liability <- function(params) {
  sim.result <- f.call(sim, params)
  
  # lrt.cc <- run.lrt(sim.result, params, cases.only = F)
  lrt.co <- run.lrt(sim.result, params, cases.only = T)
   
  x <- data.frame(sim.result)
  
  fwd.p.val = lmtest::lrtest(
    lm(y ~ 1 + X + G + GX, data = x),
    lm(y ~ 1 + X, data = x)
  )[2,5]
  
  wilcox.p.val <- wilcox.test(
    X ~ G,
    data = x[x$y >= params$delta,],
    alternative = 'greater'
  )$p.value
  
  sim.result$Y <- sim.result$y >= params$delta # for z-test
  
  setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
    #modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
    modifyList(
        list(
          fwd.p.val = fwd.p.val,
          wilcox.p.val = wilcox.p.val
        )
    ) %>%
      modifyList(z.test(w = params$omega, sim.result))
}

params.liability <- list(
  n = 500000,
  omega = 0.001,
  alpha = 0,
  beta = 0.3,
  gamma = 0.0,
  eta = 0,
  delta = 1.33,
  sige = 1
)

gamma.liability.range <- seq(0.0, 1.2, length.out = 9)
eta.liability.range <- c(-0.4, 0)

n.liability.sims <- 1024

lrt.liability.ranges <- expand.grid(gamma = gamma.liability.range, eta = eta.liability.range)

lrt.liability.result <- mapply(function(gamma, eta) {
  params.liability$gamma <- gamma
  params.liability$eta <- eta
  
  r <- run.lrt.sims(f.lrt.liability, params.liability, n.sims = n.liability.sims)
  
  r$param.gamma <- gamma
  r$param.eta <- eta
  
  r
}, lrt.liability.ranges$gamma, lrt.liability.ranges$eta, SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

saveRDS(lrt.liability.result, file.path(out.dir, 'liability.lrt.result.rds'))
# lrt.liability.result <- readRDS(file.path(out.dir, 'liability.lrt.result.rds'))

# lrt.liabilityG.result <- lapply(
#   list.files('.data/liabilityG_1024_beta0.5_optim_v1/', full.names = T),
#   readRDS
#   ) %>%
#   bind_rows() %>%
#   arrange(gamma, eta)
```

## generate power curves

```{r}
lrt.liability.result <- readRDS('./.data/power_analysis/liability.lrt.result.rds')
lrt.liability.power <- lrt.liability.result %>%
  select(param.gamma, param.eta, ends_with('gamma'), ends_with('.p.val')) %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(across(starts_with('param')), test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup() %>%
  filter(param.eta != 0.1) %>%
  filter(test != 'cc.lrt')
  # mutate(test = gsub('^co.', '', test))

lrt.liability.power.sigmoid <- expand.grid(
  unique(lrt.liability.power$test),
  unique(lrt.liability.power$param.eta)
) %>%
  apply(1, function(vals) {
    test <- vals[1]
    eta <- as.numeric(vals[2])
    power.df <- lrt.liability.power[
      lrt.liability.power$test == test &
        lrt.liability.power$param.eta == eta,]
    my.sigmoid <- fit.sigmoid(power.df$param.gamma, power.df$power,res.fit=0.005) %>%
      rename('param.gamma' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid$param.eta <- eta
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.liability.power$src <- 'data'
lrt.liability.power.sigmoid$src <- 'fit'

compare.liability.df <- bind_rows(
  lrt.liability.power,
  lrt.liability.power.sigmoid
) %>%
  mutate(
    param.eta = as.factor(param.eta),
    test = factor(test.labels[test], levels = test.labels),
  )

(
  compare.liability.df %>%
      ggplot(aes(x = param.gamma, y = power, color = test)) +
      scale_color_manual(values = lbl.colors, name = NULL) +
      geom_line(aes(linetype = param.eta), linewidth = 0.53,
        data = subset(compare.liability.df, src == 'fit')
      ) +
      geom_point(aes(shape = param.eta), size = 1,
        data = subset(compare.liability.df, src == 'data')
      ) +
      scale_shape_manual(values = c(
        '-0.4' = 21,
        '0' = 16
      )) +
      scale_x_continuous(limits = c(0, 1.2), breaks = seq(0, 1.2, by = 0.2)) +
      scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
      labs(
        x = expression(gamma),
        y = 'Power',
        color = 'Test',
        shape = expression(eta),
        linetype = expression(eta),
      ) +
      theme_bw(base_family="Arial") +
      theme(
        panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
        panel.grid.minor = element_line(color = "grey90", linewidth = 0.25),
        # axis.line = element_blank(),
        # axis.line.x.bottom = element_line(color="black"),
        # axis.line.y.left = element_line(color="black"),
        axis.text = element_text(size=8),
        axis.title = element_text(size=8, family = "Arial", face = "bold"),
        legend.text = element_text(size=6),
        legend.title = element_text(size=8),
        legend.position = c(0.8, 0.5),
        # legend.justification = c(1, 0),
        legend.background = element_rect(fill = "white"),
        legend.spacing.y = unit(0, "cm"),
        legend.key.height = unit(0.5, "lines"),
        legend.margin = margin(1, 1, 1, 1)
      ) +
      guides(
        color = guide_legend(order = 1),
        shape = guide_legend(order = 2),
        linetype = guide_legend(order = 2)
      )
) %>%
  save.plot('supp.fig3', root.dir = out.dir, w = 3.34, h = 3.34)
```



# save params object ####

```{r save_params}
list(
  logitG.params = unlist(params),
  liabilityG.params = unlist(params.liability),
  logitG.null.w.params = unlist(params.e),
  logitG.nonnull.w.params = unlist(params.o)
) %>%
  saveRDS(file.path(out.dir, 'power.params.rds'))
```




# save data ####

```{r save_data}
list(
  logitG.power = lrt.power,
  liabilityG.power = lrt.liability.power,
  t1e.power = lrt.e.power,
  overspec.power = lrt.o.power
) %>%
  saveRDS(file.path(out.dir, 'simulation.power.results.RDS'))
```


# supplemental logitG control contamination analysis ####

## re-load logitG equations

```{r reload_logitG_equations, message=F, results='hide'}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())
```

## run sims

```{r load_liabilityG_results, cache=T, cache.extra=file.info('.data/liabilityG_1024_beta0.5_optim_v1/')}
f.lrt.c <- function(params) {
  sim.result <- f.call(sim, params)
  
  Y1G1.idx <- which(sim.result$Y == 1 & sim.result$G == 1 )
  
  c.range <- c(0, 0.1, 0.25, 0.5, 0.9)
  
  a <- lapply(c.range, function(c.level) {
    contaminated.sim.result <- sim.result
    contaminated.idx <- sample(Y1G1.idx, floor(c.level * length(Y1G1.idx)))
    contaminated.sim.result$Y[contaminated.idx] <- 0
    
    x <- data.frame(contaminated.sim.result)
    
    lrt.co <- run.lrt(contaminated.sim.result, params, cases.only = T)
    
    fwd.p.val <- lmtest::lrtest(
      glm(Y ~ 1 + X + G + GX, family = binomial(link = 'logit'), data = x),
      glm(Y ~ 1 + X, family = binomial(link = 'logit'), data = x)
    )[2,5]
     
    wilcox.p.val <- wilcox.test(
      X ~ G,
      data = x[x$Y==1,],
      alternative = 'greater'
    )$p.value
    
    r <- setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
      # modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
      modifyList(
        list(
          fwd.p.val = fwd.p.val,
          wilcox.p.val = wilcox.p.val
        )
      ) %>%
        modifyList(z.test(w = params$omega, contaminated.sim.result))
    
    r$c.lvl <- c.level
    r
  }) %>%
    do.call(bind_rows, .)
}

params.c <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  beta = 0.6,
  eta = -0.4,
  gamma = 0.6
)

n.c.sims <- 32

lrt.c.result <- run.lrt.sims(f.lrt.c, params.c, n.sims = n.c.sims)

saveRDS(lrt.c.result, file.path(out.dir, 'c.lrt.result.rds'))
```

## generate power curves

```{r}
lrt.c.power <- lrt.c.result %>%
  select(c.lvl, ends_with('gamma'), ends_with('.p.val')) %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(test, c.lvl) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup()

lrt.c.power.sigmoid <- expand.grid(
  unique(lrt.c.power$test)
) %>%
  apply(1, function(vals) {
    test <- vals[1]
    power.df <- lrt.c.power[
      lrt.c.power$test == test,]
    my.sigmoid <- fit.sigmoid(power.df$c.lvl, power.df$power, res.fit = 0.05) %>%
      rename('c.lvl' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.c.power$src <- 'data'
lrt.c.power.sigmoid$src <- 'fit'

test.c.colors <- c(
  'wilcox' = '#e32ff4',
  'co.lrt' = '#f42e3d',
  'z' = '#2ff4e4',
  'fwd' = '#2ff481'
)

compare.c.df <- bind_rows(
  lrt.c.power,
  lrt.c.power.sigmoid
) %>%
  filter(test %in% names(test.c.colors))

power.c.plt <- (
  compare.c.df %>%
    ggplot(aes(x = c.lvl, y = power, color = test)) +
    scale_color_manual(values = test.c.colors) +
    geom_line(linewidth = 2/3,
              data = subset(compare.c.df, src == 'fit')
    ) +
    geom_point(size = 2,
               data = subset(compare.c.df, src == 'data')
    ) +
    # scale_shape_manual(values = c(
    #   '0' = 16,
    #   '-0.4' = 21
    # )) +
    # scale_linetype_manual(values = c('-0.4' = 'dotted', '0' = 'solid')) +
    scale_x_continuous(
      limits = c(0, 1),
      breaks = seq(0, 1, by = 0.25)
    ) +
    labs(
      x = 'Contamination Level',
      y = 'Power',
      color = 'Test',
    )
) %>%
  save.plot('lrt.c.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.c.plt
```

# Vary Beta ####

## run sims

```{r execute_beta_lrt_sims, cache=T}
source('../lrt_equations/equations.logitG.R')

# cc.logitG.equations <- define.logitG.equations(cases.only=F)
co.logitG.equations <- define.logitG.equations(cases.only=T)

f.lrt.beta <- function(params) {
  sim.result <- f.call(sim, params)
  x <- as.data.frame(sim.result)
  
  # lrt.cc <- run.lrt(sim.result, params, cases.only = F)
  lrt.co <- run.lrt(co.logitG.equations, sim.result, params)
  
  # fwd.p.val <- lmtest::lrtest(
  #   glm(Y ~ 1 + X + G + GX, family = binomial(link = 'logit'), data = x),
  #   glm(Y ~ 1 + X, family = binomial(link = 'logit'), data = x)
  # )[2,5]
  fwd.p.val <- NULL
  
  wilcox.p.val <- wilcox.test(
    X ~ G,
    data = x[x$Y==1,],
    alternative = 'greater'
  )$p.value
  
  setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
    # modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
    modifyList(
      list(
        fwd.p.val = fwd.p.val,
        wilcox.p.val = wilcox.p.val
      )
    ) %>%
      modifyList(z.test(w = params$omega, sim.result))
}

params.beta <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  # beta = 0.6,
  gamma = 0.6
)

beta.range <- c(0, 0.1, 0.3, 0.6)
eta.range <- c(-0.4, 0)

lrt.ranges.beta <- expand.grid(beta = beta.range, eta = eta.range)

lrt.result.beta <- mapply(function(beta, eta) {
  params.beta$beta <- beta
  params.beta$eta <- eta
  
  r <- run.lrt.sims(f.lrt.beta, params.beta, n.sims = 32)
  
  r$param.gamma <- params.beta$gamma
  r$param.omega <- params.beta$omega
  r$param.alpha <- params.beta$alpha
  r$param.beta <- params.beta$beta
  r$param.eta <- params.beta$eta
  
  r
}, lrt.ranges.beta$beta, lrt.ranges.beta$eta, SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.power.beta <- lrt.result.beta %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  select(param.beta, param.eta, ends_with('.p.val')) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(across(starts_with('param')), test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup()
saveRDS(lrt.power.beta, file.path(out.dir, 'beta.lrt.power.rds'))
```

## generate power curve

```{r generate_beta_power_curve}
lrt.power.beta.sigmoid <- expand.grid(unique(lrt.power.beta$test), unique(lrt.power.beta$param.eta)) %>%
  apply(1, function(vals) {
    test <- vals[1]
    param.eta <- as.numeric(vals[2])
    power.df <- lrt.power.beta[
      lrt.power.beta$test == test & lrt.power.beta$param.eta == param.eta,]
    my.sigmoid <- fit.sigmoid(power.df$param.beta, power.df$power) %>%
      rename('param.beta' = x, 'power' = y)
    my.sigmoid$test <- test
    my.sigmoid$param.eta <- param.eta
    my.sigmoid
  }) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

lrt.power.beta$src <- 'data'
lrt.power.beta.sigmoid$src <- 'fit'

compare.df.beta <- bind_rows(
  lrt.power.beta,
  lrt.power.beta.sigmoid
) %>%
  mutate(
    param.eta = as.factor(param.eta),
    test = factor(test.labels[test], levels = test.labels)
  )

power.plt.beta <- (
  compare.df.beta %>%
  ggplot(aes(x = param.beta, y = power, color = test)) +
  scale_color_manual(values = lbl.colors, name = NULL) +
  geom_line(aes(linetype = param.eta), linewidth = 2/3,
    data = subset(compare.df.beta, src == 'fit')
  ) +
  geom_point(aes(shape = param.eta), size = 2,
    data = subset(compare.df.beta, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '-0.4' = 21,
    '0' = 16
  )) +
  scale_linetype_manual(values = c('0' = 'solid', '-0.4' = 'dotted')) +
  scale_x_continuous(limits = c(0, 0.6), breaks = seq(0, 0.6, by = 0.1)) +
  labs(
    x = expression(beta),
    y = 'Power',
    color = 'Test',
    shape = expression(eta),
    linetype = expression(eta),
  )
) %>%
  save.plot('power.plt.beta', root.dir = out.dir, w = 4.5, h = 4.5)

power.plt.beta
```





# beta fun ####

## run sims

```{r execute_beta_lrt_sims, cache=T}
source('../lrt_equations/equations.logitG.R')
list2env(lrt.logitG.equations, envir = environment())

f.lrt.beta <- function(params) {
  sim.result <- f.call(sim, params)
  
  # a <- 0.85 # looks good w/ eta = -0.4
  a <- params$a
  
  # params$omega <- params$omega + a * (params$omega * f.call(R1, modifyList(params, list(X = 0))) - params$omega)
  
  x <- as.data.frame(sim.result)
  
  if (params$E.omega) {
    E.omega <- (params$omega / (1 - params$omega)) *
      (
        f.call(pY, modifyList(params, list(X = 0, G = 1))) /
        (f.call(pY, modifyList(params, list(X = 0, G = 0))))
      )
    params$omega <- params$omega + a * (E.omega - params$omega)
  } else {
    params$omega <- params$omega + a * (mean(x[x$Y==1,]$G) - params$omega)
  }
  
  # lrt.cc <- run.lrt(sim.result, params, cases.only = F)
  lrt.co <- run.lrt(sim.result, params, cases.only = T)
  
  # fwd.p.val <- lmtest::lrtest(
  #   glm(Y ~ 1 + X + G + GX, family = binomial(link = 'logit'), data = x),
  #   glm(Y ~ 1 + X, family = binomial(link = 'logit'), data = x)
  # )[2,5]
  fwd.p.val <- NULL
  
  wilcox.p.val <- wilcox.test(
    X ~ G,
    data = x[x$Y==1,],
    alternative = 'greater'
  )$p.value
  
  setNames(lrt.co, paste('co', names(lrt.co), sep='.')) %>%
    # modifyList(setNames(lrt.cc, paste('cc', names(lrt.cc), sep='.'))) %>%
    modifyList(
      list(
        fwd.p.val = fwd.p.val,
        wilcox.p.val = wilcox.p.val
      )
    ) %>%
    modifyList(z.test(w = params$omega, sim.result)) %>%
    modifyList(list(o.s = params$omega))
}

params.beta <- list(
  n = 5e5,
  omega = 0.001,
  alpha = -2.2,
  # eta = 0.05,
  # beta = 0.6,
  gamma = 2.2
)

n.sims <- 64

lrt.ranges.beta <- expand.grid(
  beta = c(0.1, 0.5),
  eta = c(-0.4),
  a = seq(0.85, 0.95, by = 0.05),
  E.omega = c(T, F)
)

dim(lrt.ranges.beta)

lrt.result.beta <- mapply(function(beta, eta, a, E.omega) {
  params.beta$beta <- beta
  params.beta$eta <- eta
  params.beta$a <-a
  params.beta$E.omega <- E.omega
  
  r <- run.lrt.sims(f.lrt.beta, params.beta, n.sims = n.sims)
  
  r$param.gamma <- params.beta$gamma
  r$param.omega <- params.beta$omega
  r$param.alpha <- params.beta$alpha
  r$param.beta <- params.beta$beta
  r$param.eta <- params.beta$eta
  r$param.a <- params.beta$a
  r$param.E.omega <- params.beta$E.omega
  
  r
}, lrt.ranges.beta$beta, lrt.ranges.beta$eta, lrt.ranges.beta$a, lrt.ranges.beta$E.omega, SIMPLIFY = F) %>%
  do.call(bind_rows, .) %>%
  as_tibble()

# lrt.result.beta <- bind_rows(lrt.result.beta, lrt.result.beta.bak)

saveRDS(lrt.result.beta, file.path(out.dir, 'beta.lrt.result.rds'))
```

## generate power curve

```{r generate_beta_power_curve}
lrt.power.beta <- lrt.result.beta %>%
  mutate(
    # cc.lrt.p.val = ifelse(cc.gamma < 0, 1, cc.lrt.p.val),
    co.lrt.p.val = ifelse(co.gamma < 0, 1, co.lrt.p.val)
  ) %>%
  select(starts_with('param'), ends_with('.p.val')) %>%
  pivot_longer(cols = ends_with('.p.val'), names_to = 'test', values_to = 'p.val') %>%
  mutate(test = gsub('.p.val', '', test)) %>%
  group_by(param.beta, param.eta, param.a, param.E.omega, test) %>%
  summarize(power = mean(p.val < 0.05)) %>%
  ungroup() %>%
  # filter(test != 'cc.lrt') %>%
  mutate(test = gsub('^co.', '', test))

# lrt.power.beta.sigmoid <- expand.grid(unique(lrt.power.beta$test), unique(lrt.power.beta$param.beta)) %>%
#   apply(1, function(vals) {
#     test <- vals[1]
#     param.beta <- as.numeric(vals[2])
#     power.df <- lrt.power.beta[
#       lrt.power.beta$test == test & lrt.power.beta$param.beta == param.beta,]
#     my.sigmoid <- fit.sigmoid(power.df$param.gamma, power.df$power) %>%
#       rename('param.gamma' = x, 'power' = y)
#     my.sigmoid$test <- test
#     my.sigmoid$param.beta <- param.beta
#     my.sigmoid
#   }) %>%
#   do.call(bind_rows, .) %>%
#   as_tibble()

lrt.power.beta$src <- 'data'
# lrt.power.beta.sigmoid$src <- 'fit'

compare.df.beta <- bind_rows(
  lrt.power.beta,
  # lrt.power.beta.sigmoid
) %>%
  mutate(param.beta = as.factor(param.beta))

test.colors <- c(
  'lrt' = '#f42e3d',
  # 'fwd' = '#2ff481',
  'wilcox' = '#e32ff4',
  'z' = '#2ff4e4'
)

power.plt.beta <- (
  compare.df.beta %>%
  ggplot(aes(x = param.a, y = power, color = test)) +
  scale_color_manual(values = test.colors) +
  # geom_line(aes(linetype = param.beta), linewidth = 2/3,
  #   data = subset(compare.df.beta, src == 'fit')
  # ) +
  geom_point(aes(shape = param.beta), size = 2,
    data = subset(compare.df.beta, src == 'data')
  ) +
  scale_shape_manual(values = c(
    '0.1' = 21,
    '0.3' = 13,
    '0.5' = 16
  )) +
  # scale_linetype_manual(values = c('0.5' = 'solid', '0.3' = 'dashed', '0.1' = 'dotted')) +
  # scale_x_continuous(limits = c(0, max(gamma.range)), breaks = seq(0, max(gamma.range), length = 7)) +
    facet_grid(rows = vars(param.eta), cols = vars(param.E.omega)) +
  labs(
    x = 'a',
    y = 'Power',
    color = 'Test',
    shape = expression(beta),
    linetype = expression(beta),
  )
) %>%
  save.plot('lrt.power', root.dir = out.dir, w = 4.5, h = 4.5)

power.plt.beta
```